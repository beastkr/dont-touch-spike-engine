(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{BACKGROUND_IMAGE:()=>k,BUTTON_SPRITE:()=>C,GROUND:()=>S,PLAYER_SPRITE:()=>j,SPIKE_UP:()=>L});class s{static initialize(e){s.camera=e,s.canvas||(s.canvas=document.createElement("canvas")),s.canvas.getContext("2d"),s.canvas.height=e.transform.scale.y,s.canvas.width=e.transform.scale.x,s.canvas.style.position="absolute",s.canvas.style.top="50%",s.canvas.style.left="50%",s.canvas.style.transform="translate(-50%, -50%)",document.body.appendChild(s.canvas)}static flip(){const e=document.querySelector("canvas").getContext("2d");e&&(e.imageSmoothingEnabled=!1,e.fillStyle="white",e.fillRect(0,0,s.camera.transform.scale.x,s.camera.transform.scale.y))}static getCanvas(){return s.canvas}}const i=s;class r{static reset(e){let t=r.sceneColliderList.get(e);r.listcollider=t||[]}static addcollider(e,t){var s;r.sceneColliderList.has(t)||r.sceneColliderList.set(t,[]),r.listcollider.push(e),null===(s=r.sceneColliderList.get(t))||void 0===s||s.push(e),r.size.set(t,(r.size.get(t)||0)+1)}static getAllColliders(e){return _.sceneList.has(e)&&r.sceneColliderList.get(e)||[]}}r.sceneColliderList=new Map,r.listcollider=[],r.size=new Map;const n=r,o=class{},a=class{constructor(e,t){this.x=null!=e?e:0,this.y=null!=t?t:0}squaredistance(e){const t=this.x-e.x,s=this.y-e.y;return t*t+s*s}},l=class extends o{constructor(e,t){super(),this.flip=new a(1,1),this.rotation=0,this.position=null!=e?e:new a(0,0),this.scale=null!=t?t:new a(1,1)}};class c{static initialize(){}static loadImages(e){return t=this,s=void 0,r=function*(){const t=e=>new Promise(((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=s,i.src="https://beastkr.github.io/dont-touch-spike-engine/assets/images/"+e}));for(const s of e)try{const e=yield t(s),i="/assets/images/"+s;c.imagelist[i]=e,console.log(`Loaded image: ${i}`)}catch(e){console.error(`Failed to load image: ${s}`,e)}},new((i=void 0)||(i=Promise))((function(e,n){function o(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i((function(e){e(s)}))).then(o,a)}l((r=r.apply(t,s||[])).next())}));var t,s,i,r}static addtolist(e){for(var t of e)c.imgpathlist.push(t)}}c.imagelist={},c.imgpathlist=[];const h=c,p=class extends o{constructor(e){if(super(),this.image=new Image,this.flipvector=new a(1,1),this.imgpath=null!=e?e:"",e&&""!=this.imgpath){const t=h.imagelist["/assets/images/"+e];this.image=t}this.color=[0,0,0,1]}rgb(){return`rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`}flipimage(e){this.flipvector=e}render(e,t,s,i){const r=document.querySelector("canvas");this.ctx=r.getContext("2d");let n=this.ctx;if(!n)return;const o=e.x-s.x,a=e.y-s.y;n.save(),n.translate(o,a),n.scale(this.flipvector.x,this.flipvector.y);const l=(this.flipvector.x,-t.x/2),c=(this.flipvector.y,-t.y/2);if(n.rotate(this.rotation*Math.PI/180),""===this.imgpath)n.beginPath(),n.globalAlpha=this.color[3],n.arc(0,0,t.x/2,0,2*Math.PI),n.fillStyle=this.rgb(),n.fill(),n.globalAlpha=1;else if(i){const[e,s,r,o]=i;n.drawImage(this.image,e,s,r,o,l,c,t.x,t.y)}else n.drawImage(this.image,l,c,t.x,t.y);n.restore()}rotate(e){this.rotation=e}},d=class{constructor(e,t,s){this.spriterenderer=new p,this.transform=new l(t,s)}render(e,t){if(this.spriterenderer){let e=this.transform.position,s=this.transform.scale;this.spriterenderer.rotate(this.transform.rotation),this.spriterenderer.render(e,s,t)}}update(e){}},u=class extends d{constructor(e){super(e),this.transform.scale=new a(400,700)}},m=class{constructor(e){this.originalPos=new Map,this.name=e||"default",this.gameObject=[],this.camera=new u(this.name),i.canvas||i.initialize(this.camera),U.initialize()}pushGameObject(e){this.gameObject.push(e);let t=new a(e.transform.position.x,e.transform.position.y),s=new a(e.transform.scale.x,e.transform.scale.y);this.originalPos.set(e,[t,s])}reset(){for(const e of this.gameObject){const t=this.originalPos.get(e);t&&(e.transform.position=new a(t[0].x,t[0].y),e.transform.scale=new a(t[1].x,t[1].y)),"reset"in e&&"function"==typeof e.reset&&e.reset()}}update(e){for(var t of this.gameObject)t.update(e)}render(e){for(var t of(i.flip(),this.gameObject))t.render(e,this.camera.transform.position)}},g=class{constructor(e){this.isTrigger=!1,this.id=n.size.get(e)||0,n.addcollider(this,e),this.layer="default"}collide(e){return[this,!1]}drawDebug(e){e&&!this.isTrigger&&(e.strokeStyle="red",e.strokeRect(this.position.x-this.scale.x/2,this.position.y-this.scale.y/2,this.scale.x,this.scale.y))}checkCollide(){return[]}};class f extends g{constructor(e,t,s){var i,r;super(e),this.sceneKey=e,t=null!=t?t:new a,s=null!=s?s:new a,this.position=null!==(i=new a(t.x,t.y))&&void 0!==i?i:new a,this.scale=null!==(r=new a(s.x,s.y))&&void 0!==r?r:new a(1,1)}collide(e){for(var t in n.getAllColliders(this.sceneKey)){let s=n.getAllColliders(this.sceneKey)[t];if(t!==String(this.id)&&s instanceof f&&s.layer==e){const e=s,t=this.position.x-this.scale.x/2,i=this.position.x+this.scale.x/2,r=this.position.y-this.scale.y/2,n=this.position.y+this.scale.y/2,o=e.position.x-e.scale.x/2,a=e.position.x+e.scale.x/2,l=e.position.y-e.scale.y/2,c=e.position.y+e.scale.y/2;if(t<a&&i>o&&r<c&&n>l)return[e,!0]}}return[this,!1]}checkCollide(){let e=[];for(var t in n.getAllColliders(this.sceneKey)){let s=n.getAllColliders(this.sceneKey)[t];if(t!==String(this.id)&&s instanceof f){const t=s,i=this.position.x-this.scale.x/2,r=this.position.x+this.scale.x/2,n=this.position.y-this.scale.y/2,o=this.position.y+this.scale.y/2,a=t.position.x-t.scale.x/2,l=t.position.x+t.scale.x/2,c=t.position.y-t.scale.y/2,h=t.position.y+t.scale.y/2;i<l&&r>a&&n<h&&o>c&&e.push(t)}}return e}}const w=f,y=class extends d{constructor(e,t,s,i){super(e,t,s),this.text=null!=i?i:[],this.spriterenderer.color=[0,0,0,0]}render(e,t){super.render(e,t);const s=this.spriterenderer.ctx;if(!s)return;let i=this.transform.position;s.font=this.text[1],s.fillStyle=this.text[2],s.textAlign="center",s.textBaseline="middle",s.fillText(this.text[0],i.x,i.y)}update(e){}},x=class extends d{constructor(e,t,s){super(e,t,s),this.spriterenderer=new p("button.png"),this.onclickcallbacks=[],this.text=new y(e,t,s),this.text.text=["Button","20px Arieal","red"],this.collider=t&&s?new w(e,t,s):new w(e),this.collider.layer="button"}update(e){super.update(e),this.hovered=this.collider.collide("cursor")[1],this.hovered&&this.onhover(),U.mousepos&&this.hovered&&0!=U.mousepos[2]&&0!=U.mousepos[3]&&(U.mousepos[2]=0,U.mousepos[3]=0,this.onclicked())}render(e,t){super.render(e,t);const s=this.spriterenderer.ctx;s&&(this.transform.position,this.text.render(e,t),this.collider.drawDebug(s))}onclicked(){console.log("clicked");for(const e of this.onclickcallbacks)e()}addonclick(e){this.onclickcallbacks.push(e)}setText(e){this.text.text[0]=e}onhover(){}},v=class extends d{constructor(e,t,s){super(e,t,s),this.layer="default",this.collider=new w(e,t,s)}update(e){this.collider.position.x=this.transform.position.x,this.collider.position.y=this.transform.position.y,super.update(e)}render(e,t){super.render(e,t),this.collider&&this.collider.drawDebug(this.spriterenderer.ctx)}},b=class extends v{constructor(e,t,s){super(e,t,s),this.clicking=!1,U.mousepos=[0,0,0,0],this.collider=t&&s?new w(e,t,s):new w(e),this.collider.layer="cursor",this.spriterenderer=new p,this.spriterenderer.color=[0,0,0,0]}update(e){super.update(e),this.transform.position.x=U.mousepos[0],this.transform.position.y=U.mousepos[1]}render(e,t){super.render(e,t),this.collider.drawDebug(this.spriterenderer.ctx)}},k="bg.png",j="MouseSpritesheet.png",C="button.png",L="spikeup.png",S="groundup.png";class O{static reset(){this.score=0,O.text.text[0]="0"}static increase(){this.score++,this.score>this.highscore&&(this.highscore=this.score,this.highScoreText.text[0]=String(this.highscore)),O.text.text[0]=String(O.score)}}O.score=0,O.highscore=0;const A=O,T=class extends m{constructor(){super("menu");let e=new d(this.name,new a(200,350),new a(400,700));e.spriterenderer=new p(k),this.pushGameObject(e);let t=[String(A.score),"100px Arieal","white"],s=new y(this.name,new a(200,100),new a(200,100),t);A.highScoreText=s,this.pushGameObject(s);let i=new x(this.name,new a(200,400),new a(200,100));i.setText("Start Game"),i.addonclick((()=>{_.setActive("game")})),this.pushGameObject(i),this.pushGameObject(new b(this.name,new a(0,0),new a(20,20))),console.log(this.gameObject),console.log(n.sceneColliderList)}update(e){super.update(e)}render(e){super.render(e)}},G=class extends m{constructor(){super("loading"),this.resources=Object.values(t),h.addtolist(this.resources),h.loadImages(this.resources).then((()=>{console.log("All resources loaded"),_.initScene(),_.setActive("menu")})).catch((e=>{console.error("Error loading resources:",e)}))}},P=class extends v{constructor(e,t,s){super(e,t,s),this.collider.layer="player"}update(e){super.update(e)}render(e,t){super.render(e,t),this.animator&&this.spriterenderer.render(this.transform.position,this.transform.scale,t,this.animator.getCurrentFrameRect())}},z=class{constructor(e){this.power=null!=e?e:new a(0,0)}},R=class extends z{constructor(){super(),this.power=new a(0,300)}};class M{static initialize(){M.gravity=new R}static addforce(e,t,s){e.x=e.x+t.power.x*s,e.y=e.y+t.power.y*s}}const E=M,F=class extends o{constructor(e){super(),this.fps=4,this.currentindex=0,this.safeprogress=0,this.starttime=0,this.spritesheet=!1,this.frameWidth=0,this.frameHeight=0,this.numFrames=0,this.animation=[],this.sprite=e,this.interval=1e3/this.fps}loadAnim(e,t,s,i){this.spritesheet=e,e&&"string"==typeof t&&s&&i?(this.sprite.image=h.imagelist["/assets/images/"+t],this.frameWidth=s,this.frameHeight=i,this.numFrames=Math.floor(this.sprite.image.width/s)):!e&&Array.isArray(t)&&(this.animation=t.map((e=>"../../assets/images/"+e)))}play(e){if(0===this.fps)return;0===this.starttime&&(this.starttime=performance.now());let t=Math.floor(performance.now()%1e3/this.interval);t!==this.safeprogress&&(this.safeprogress=t,this.currentindex=(this.currentindex+1)%(this.spritesheet?this.numFrames:this.animation.length),this.spritesheet||(this.sprite.image.src=this.animation[this.currentindex]))}getCurrentFrameRect(){if(this.spritesheet)return[this.currentindex*this.frameWidth,0,this.frameWidth,this.frameHeight]}stop(){this.fps=0}continue(){this.fps=4}},I=class extends P{constructor(e,t,s){super(e,t,s),this.jumpCounter=0,this.jumpable=!0,this.jumping=!1,this.touchCeiling=!1,this.jumpForce=new z(new a(0,-800)),this.speed=new z(new a(200,0)),this.facingLeft=!1,this.bouncing=!1,this.onground=!1,this.spriterenderer=new p(j),this.animator=new F(this.spriterenderer),this.animator.loadAnim(!0,j,16,16)}update(e){if(super.update(e),E.addforce(this.transform.position,this.speed,e),this.onground){let e=this.collider.collide("ground")[0];this.transform.position.y=e.position.y-this.transform.scale.y/2-e.scale.y/2+1}else E.addforce(this.transform.position,E.gravity,e);if(this.statReset(),this.collider.checkCollide()){let e=this.collider.checkCollide();for(var t of e)"ground"==t.layer&&(this.onground=!0),"ceiling"==t.layer&&(this.touchCeiling=!0)}this.collider.collide("wall")[1]&&!this.bouncing?(A.increase(),this.spikeLeft.expose(),this.spikeright.expose(),this.facingLeft=!this.facingLeft,this.bouncing=!0,this.speed.power.x=-this.speed.power.x,this.transform.flip.x=-this.transform.flip.x,this.spriterenderer.flipimage(this.transform.flip)):this.collider.collide("wall")[1]||(this.bouncing=!1),this.jumpable||(this.jumpCounter+=e),this.jumpCounter>=.15&&(this.jumping=!1,""==U.key&&(this.jumpable=!0,this.jumpCounter=0)),this.jumping&&!this.touchCeiling&&E.addforce(this.transform.position,this.jumpForce,e),this.animator.play(e)," "==U.key&&this.jumpable&&(this.jumpable=!1,this.jumping=!0,this.jumpCounter=0),this.collider.collide("spike")[1]&&this.gameover()}render(e,t){super.render(e,t)}statReset(){this.onground=!1,this.touchCeiling=!1}reset(){this.onground=!1,this.touchCeiling=!1,this.bouncing=!1,this.facingLeft=!1,this.jumpable=!0,this.jumping=!1,this.transform.flip.x=1,this.jumpCounter=0,this.speed.power.x=200}gameover(){_.setActive("menu")}},D=class extends v{constructor(e,t,s){super(e,t,s),this.collider.layer="spike",this.spriterenderer=new p(L),this.collider.scale.y=this.transform.scale.y/2}update(e){super.update(e)}render(e,t){super.render(e,t)}},K=class extends d{constructor(e,t,s,i){super(e),this.isLeft=!1,90==s&&(this.isLeft=!0),this.marginPos=i,this.spikelist=[];for(let i=0;i<t;i++){let t=new D(e,new a(-100,-100),new a(50,50));t.transform.rotation=s,this.spikelist.push(t)}}hide(){for(let e of this.spikelist)this.player.facingLeft==this.isLeft&&(e.transform.position=new a(-100,-100))}expose(){const e=this.isLeft?15:-15;if(this.player.facingLeft!==this.isLeft)for(const t of this.spikelist){let s,i=0,r=!1;for(;i<3&&!r;){s=this.getRandom(50,500),t.transform.position=new a(this.marginPos+e,s);const[,n]=t.collider.collide("spike");n||(r=!0),i++}r||console.warn("Spike placement failed after retries.")}else this.hide()}update(e){for(let t of this.spikelist)t.update(e)}render(e,t){for(let s of this.spikelist){s.render(e,t);const i=document.querySelector("canvas").getContext("2d");s.collider.drawDebug(i)}}setplayer(e){this.player=e}reset(){for(let e of this.spikelist)e.transform.position=new a(-100,-100)}getRandom(e,t){return Math.floor(Math.random()*(t-e))+e}},q=class extends m{constructor(){super("game");let e=new d(this.name,new a(200,350),new a(400,700));e.spriterenderer=new p(k),this.pushGameObject(e);let t=[String(A.score),"100px Arieal","white"],s=new y(this.name,new a(200,350),new a(200,100),t);A.text=s,this.pushGameObject(s);let i=new v(this.name,new a(0,350),new a(5,700));i.spriterenderer=new p(j),i.collider.layer="wall",this.pushGameObject(i),i=new v(this.name,new a(400,350),new a(5,700)),i.spriterenderer=new p(j),i.collider.layer="wall",this.pushGameObject(i);let r=new v(this.name,new a(200,700),new a(400,350));r.spriterenderer=new p(S),r.collider.layer="spike",this.pushGameObject(r);let n=new v(this.name,new a(200,0),new a(400,50));n.transform.rotation=180,n.spriterenderer=new p(S),n.collider.layer="spike",this.pushGameObject(n);let o=new I(this.name,new a(200,200),new a(30,30)),l=new K(this.name,5,90,0),c=new K(this.name,5,270,400);o.spikeLeft=l,o.spikeright=c,c.setplayer(o),l.setplayer(o),this.pushGameObject(l),this.pushGameObject(c),this.pushGameObject(o)}reset(){super.reset(),A.reset()}};class B{static initialize(){B.sceneList=new Map,B.sceneList.set("loading",new G),B.setActive("loading")}static initScene(){B.sceneList.set("menu",new T),B.sceneList.set("game",new q)}static update(e){var t;null===(t=B.sceneList.get(B.activeScene))||void 0===t||t.update(e)}static render(e){var t;null===(t=B.sceneList.get(B.activeScene))||void 0===t||t.render(e)}static setActive(e){var t;if(B.sceneList.has(e)){n.reset(e),B.getCurrentScene().reset(),B.activeScene=e;let s=null===(t=B.sceneList.get(e))||void 0===t?void 0:t.camera;s&&i.initialize(s)}}static getCurrentScene(){return B.sceneList.get(B.activeScene)||new m}static pause(){B.pausing=!0}static resume(){B.pausing=!1}}B.pausing=!1;const _=B;class ${static initialize(){const e=document.querySelector("canvas");window.addEventListener("keydown",(e=>{$.key=e.key})),window.addEventListener("keyup",(e=>{$.key=""})),e.addEventListener("mousemove",(t=>{const s=e.getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top;$.mousepos[0]=i,$.mousepos[1]=r})),e.addEventListener("click",(t=>{const s=e.getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top;$.mousepos[0]=i,$.mousepos[1]=r,$.mousepos[2]=i,$.mousepos[3]=r})),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?(_.pause(),console.log("Game paused")):(_.resume(),console.log("Game resumed"))}))}}$.key="",$.mousepos=[0,0,0,0];const U=$;class W{static initialize(){W.prevTime=0,W.currentTime=performance.now()/1e3}static startFrame(){W.currentTime=performance.now()/1e3,W.delta()}static endFrame(){W.prevTime=W.currentTime}static delta(){W.deltaTime=W.currentTime-W.prevTime}}const H=W;(new class{constructor(){_.initialize(),E.initialize()}loop(){H.startFrame(),_.pausing&&(H.deltaTime=0),this.update(H.deltaTime),this.render(H.deltaTime),H.endFrame(),requestAnimationFrame(this.loop.bind(this))}update(e){_.update(e)}render(e){_.render(e)}start(){var e;H.initialize();let t=null===(e=_.sceneList.get(_.activeScene))||void 0===e?void 0:e.camera;t&&i.initialize(t),U.initialize(),this.loop()}}).start()})();