(()=>{"use strict";const e=class{};class t{constructor(e,t){this.x=null!=e?e:0,this.y=null!=t?t:0}squaredistance(e){const t=this.x-e.x,s=this.y-e.y;return t*t+s*s}mul(e){return new t(this.x*e,this.y*e)}}const s=t,i=class extends e{constructor(e,t){super(),this.flip=new s(1,1),this.rotation=0,this.position=null!=e?e:new s(0,0),this.scale=null!=t?t:new s(1,1)}update(e){}};var r=function(e,t,s,i){return new(s||(s=Promise))((function(r,n){function o(e){try{h(i.next(e))}catch(e){n(e)}}function a(e){try{h(i.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}h((i=i.apply(e,t||[])).next())}))};class n{static initialize(){}static loadImages(e){return r(this,void 0,void 0,(function*(){n.deploy?n.KEY="https://beastkr.github.io/dont-touch-spike-engine":n.KEY="../..";const t=e=>new Promise(((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=s,i.src=n.KEY+"/assets/images/"+e}));for(const s of e)try{const e=yield t(s),i="/assets/images/"+s;n.imagelist[i]=e}catch(e){console.error(`Failed to load image: ${s}`,e)}}))}static loadSounds(e){return r(this,void 0,void 0,(function*(){n.deploy?n.KEY="https://beastkr.github.io/dont-touch-spike-engine":n.KEY="..";const t=e=>new Promise(((t,s)=>{const i=new Audio(n.KEY+"/assets/sfx/"+e);i.preload="auto",i.oncanplaythrough=()=>t(i),i.onerror=()=>s(new Error(`Failed to load sound: ${e}`))}));for(const s of e)try{const e=yield t(s),i="/assets/sfx/"+s;n.soundList[i]=e}catch(e){console.error(`Failed to load sound: ${s}`,e)}}))}static addtolist(e){for(var t of e)n.imgpathlist.push(t)}}n.imagelist={},n.soundList={},n.imgpathlist=[],n.deploy=!0,n.loadFont=()=>r(void 0,void 0,void 0,(function*(){const e=new FontFace("PressStart",`url('${n.KEY}/assets/fonts/PressStart.ttf')`);try{yield e.load(),document.fonts.add(e)}catch(e){console.error("Failed to load font",e)}}));const o=n,a=class extends e{constructor(e){if(super(),this.image=new Image,this.flipvector=new s(1,1),this.imgpath=null!=e?e:"",e&&""!=this.imgpath){const t=o.imagelist["/assets/images/"+e];this.image=t}this.color=[0,0,0,1]}rgb(){return`rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`}flipimage(e){this.flipvector=e}render(e,t,s,i){const r=document.querySelector("canvas");this.ctx=r.getContext("2d");let n=this.ctx;if(!n)return;const o=e.x-s.x,a=e.y-s.y;n.save(),n.translate(o,a),n.scale(this.flipvector.x,this.flipvector.y);const h=(this.flipvector.x,-t.x/2),l=(this.flipvector.y,-t.y/2);if(n.rotate(this.rotation*Math.PI/180),""===this.imgpath)n.beginPath(),n.globalAlpha=this.color[3],n.arc(0,0,t.x/2,0,2*Math.PI),n.fillStyle=this.rgb(),n.fill(),n.globalAlpha=1;else if(i){const[e,s,r,o]=i;n.globalAlpha=this.color[3],n.drawImage(this.image,e,s,r,o,h,l,t.x,t.y),n.globalAlpha=1}else n.globalAlpha=this.color[3],n.drawImage(this.image,h,l,t.x,t.y),n.globalAlpha=1;n.restore()}rotate(e){this.rotation=e}},h=class{constructor(e,t,r){this.spriterenderer=new a,this.transform=new i(t,r);let n=new s(this.transform.position.x,this.transform.position.y),o=new s(this.transform.scale.x,this.transform.scale.y);this.originalTransform=new i(n,o)}render(e,t){if(this.spriterenderer){let e=this.transform.position,s=this.transform.scale;this.spriterenderer.rotate(this.transform.rotation),this.spriterenderer.render(e,s,t)}}update(e){}reset(){let e=new s(this.originalTransform.position.x,this.originalTransform.position.y),t=new s(this.originalTransform.scale.x,this.originalTransform.scale.y);this.transform=new i(e,t),this.spriterenderer.flipimage(this.transform.flip),this.transform.rotation=this.originalTransform.rotation}},l=class extends h{constructor(e,t,s,i){super(e,t,s),this.text=null!=i?i:[],this.spriterenderer.color=[0,0,0,0]}render(e,t){super.render(e,t);const s=this.spriterenderer.ctx;if(!s)return;let i=this.transform.position;s.font=this.text[1],s.fillStyle=this.text[2],s.textAlign="center",s.textBaseline="middle";let r=(null==t?void 0:t.x)||0,n=(null==t?void 0:t.y)||0;s.fillText(this.text[0],i.x-r,i.y-n)}update(e){}},c=new s(0,0),d=new s(400,550),p=class extends h{constructor(e,t){super(e,t),this.transform.scale=d}},u=class{constructor(e){this.preloadimg=[],this.preloadsfx=[],this.created=!1,this.name=e||"default",this.gameObject=[],this.camera=new p(this.name,c),ue.canvas||ue.initialize(this.camera)}create(){this.created=!0}pushGameObject(e){this.gameObject.push(e);let t=new s(e.transform.position.x,e.transform.position.y),r=new s(e.transform.scale.x,e.transform.scale.y);e.originalTransform=new i(t,r),e.originalTransform.rotation=e.transform.rotation}reset(){for(const e of this.gameObject)e.reset()}update(e){for(var t of this.gameObject)t.update(e)}render(e){for(var t of(ue.flip(),this.gameObject))t.render(e,this.camera.transform.position)}pause(){de.pausing&&ue.pause()}entry(){}};class m{static reset(e){let t=m.sceneColliderList.get(e);m.listcollider=t||[]}static addcollider(e,t){var s;m.sceneColliderList.has(t)||m.sceneColliderList.set(t,[]),m.listcollider.push(e),null===(s=m.sceneColliderList.get(t))||void 0===s||s.push(e),m.size.set(t,(m.size.get(t)||0)+1)}static getAllColliders(e){return de.sceneList.has(e)&&m.sceneColliderList.get(e)||[]}}m.sceneColliderList=new Map,m.listcollider=[],m.size=new Map;const f=m,g=class{constructor(e){this.isTrigger=!1,this.id=f.size.get(e)||0,f.addcollider(this,e),this.layer="default"}collide(e){return[this,!1]}drawDebug(e){e&&!this.isTrigger&&(e.strokeStyle="red",e.strokeRect(this.position.x-this.scale.x/2,this.position.y-this.scale.y/2,this.scale.x,this.scale.y))}checkCollide(){return[]}};class y extends g{constructor(e,t,i){var r,n;super(e),this.sceneKey=e,t=null!=t?t:new s,i=null!=i?i:new s,this.position=null!==(r=new s(t.x,t.y))&&void 0!==r?r:new s,this.scale=null!==(n=new s(i.x,i.y))&&void 0!==n?n:new s(1,1)}collide(e){for(var t in f.getAllColliders(this.sceneKey)){let s=f.getAllColliders(this.sceneKey)[t];if(t!==String(this.id)&&s instanceof y&&s.layer==e){const e=s,t=this.position.x-this.scale.x/2,i=this.position.x+this.scale.x/2,r=this.position.y-this.scale.y/2,n=this.position.y+this.scale.y/2,o=e.position.x-e.scale.x/2,a=e.position.x+e.scale.x/2,h=e.position.y-e.scale.y/2,l=e.position.y+e.scale.y/2;if(t<a&&i>o&&r<l&&n>h)return[e,!0]}}return[this,!1]}checkCollide(){let e=[];for(var t in f.getAllColliders(this.sceneKey)){let s=f.getAllColliders(this.sceneKey)[t];if(t!==String(this.id)&&s instanceof y){const t=s,i=this.position.x-this.scale.x/2,r=this.position.x+this.scale.x/2,n=this.position.y-this.scale.y/2,o=this.position.y+this.scale.y/2,a=t.position.x-t.scale.x/2,h=t.position.x+t.scale.x/2,l=t.position.y-t.scale.y/2,c=t.position.y+t.scale.y/2;i<h&&r>a&&n<c&&o>l&&e.push(t)}}return e}}const x=y;class w{static initialize(){const e=document.querySelector("canvas");window.addEventListener("keydown",(e=>{de.pausing&&de.resumable&&de.resume(),w.key=e.key})),window.addEventListener("keyup",(e=>{w.key=""})),e.addEventListener("mousemove",(t=>{const s=e.getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top;w.mousepos[0]=i/ue.ratioX,w.mousepos[1]=r/ue.ratioY,w.mousepos[2]=0,w.mousepos[3]=0})),e.addEventListener("click",(t=>{de.pausing&&de.resumable&&de.resume();const s=e.getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top;w.mousepos[0]=i/ue.ratioX,w.mousepos[1]=r/ue.ratioY,w.mousepos[2]=i/ue.ratioX,w.mousepos[3]=r/ue.ratioY})),e.addEventListener("mouseup",(()=>{w.mousepos[2]=0,w.mousepos[3]=0})),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?de.pause():de.resumable=!0})),window.addEventListener("resize",(()=>{ue.resizeCanvas(),w.initialize()})),window.addEventListener("blur",(()=>{de.pause()})),window.addEventListener("focus",(()=>{de.resumable=!0}))}static reset(){w.mousepos=[0,0,0,0]}}w.key="",w.keyboard=!0,w.mousepos=[0,0,0,0];const v=w,b=class extends h{constructor(e,t,s){super(e,t,s),this.layer="default",this.collider=new x(e,t,s)}update(e){super.update(e),this.collider.position.x=this.transform.position.x,this.collider.position.y=this.transform.position.y}render(e,t){super.render(e,t)}},S=class extends b{constructor(e,t,s){super(e,t,s),this.spriterenderer=new a("button.png"),this.onclickcallbacks=[],this.text=new l(e,t,s),this.text.text=["Button","20px Arieal","white"],this.collider=t&&s?new x(e,t,s):new x(e),this.collider.layer="button"}entry(){}update(e){super.update(e),this.hovered=this.collider.collide("cursor")[1],this.spriterenderer.color[3]=.8,this.hovered&&this.onhover(),v.mousepos&&this.hovered&&0!=v.mousepos[2]&&0!=v.mousepos[3]&&(v.mousepos[2]=0,v.mousepos[3]=0,this.onclicked())}render(e,t){super.render(e,t),this.spriterenderer.ctx&&(this.transform.position,this.text.render(e,t))}onclicked(){console.log("clicked");for(const e of this.onclickcallbacks)e()}addonclick(e){this.onclickcallbacks.push(e)}setText(e){this.text.text[0]=e}onhover(){this.spriterenderer.color[3]=1}reset(){this.hovered=!1}},k=class extends b{constructor(e,t,s){super(e,t,s),this.clicking=!1,v.reset(),this.collider=t&&s?new x(e,t,s):new x(e),this.collider.layer="cursor",this.spriterenderer=new a,this.spriterenderer.color=[0,0,0,0]}update(e){super.update(e),this.clicking=0==v.mousepos[3],this.transform.position.x=v.mousepos[0],this.transform.position.y=v.mousepos[1]}render(e,t){super.render(e,t)}reset(){this.transform.position=new s}},T="bg.png",L="MouseSpritesheet.png",C="button.png",A="spikeup.png",E="bird.png",z="logo.png";class P{static initialize(){P.highscore=Number(localStorage.getItem("highscore"))}static reset(){P.score=0}static setScore(e){P.score=e}static setHighScore(e){P.score=e,localStorage.setItem("highscore",String(e))}}P.score=0,P.highscore=0;const j=P,F="jump.mp3",O="bgm.mp3",B=class extends u{constructor(){super("menu"),this.preloadimg=[T,C,z],this.preloadsfx=[O]}update(e){super.update(e)}create(){this.created=!0;let e=new h(this.name,new s(200,350),new s(400,700));e.spriterenderer=new a(T),this.pushGameObject(e),this.addUI()}addUI(){let e=new h(this.name,new s(200,100),new s(380,150));e.spriterenderer=new a(z),this.pushGameObject(e),this.addScoreText();let t=new S(this.name,new s(200,400),new s(200,100));t.setText("Start Game"),t.text.text[1]="15px PressStart",t.text.text[2]="white",t.addonclick((()=>{de.setActive("game")})),this.pushGameObject(t),this.pushGameObject(new k(this.name,new s(0,0),new s(20,20)))}render(e){if(super.render(e),this.created){let t=this.camera.transform.position;this.scoreText.render(e,t),this.prevScoreText.render(e,t)}}entry(){j.initialize();let e=j.highscore;this.scoreText.text[0]="Highscore: "+String(e),this.prevScoreText.text[0]="Score: "+String(j.score),this.resetCursor()}resetCursor(){for(var e of this.gameObject)e instanceof k&&(e=new k(this.name,new s(0,0),new s(20,20)))}addScoreText(){this.scoreText=new l(this.name,new s(200,200),new s,["","20px PressStart","white"]),this.prevScoreText=new l(this.name,new s(200,230),new s,["","20px PressStart","white"])}},G=class extends h{constructor(e,t,s){super(e),this.iterator=0,this.playing=!1,this.once=!1,this.name=s,this.play,this.AudioSource=o.soundList["/assets/sfx/"+t],R.addAudioChannel(this)}play(){this.playing||(console.log("playing ",this.name),this.AudioSource.play().then((()=>{this.once||(this.playing=!1)}))),this.playing=!0}stop(){this.AudioSource&&this.AudioSource.pause(),this.playing=!1}};class M{static initialize(){M.channel=new Map;const e=new G("global",O,"bgm");e.once=!0,e.AudioSource.loop=!0,e.AudioSource.volume=.3}static play(e){var t;console.log(this.channel),null===(t=M.channel.get(e))||void 0===t||t.play()}static addAudioChannel(e){M.channel.set(e.name,e)}static stop(e){var t;null===(t=M.channel.get(e))||void 0===t||t.stop()}}const R=M;class Y{static initialize(){Y.tileSet=new Map}static addToTileSet(e){Y.tileSet.set(Y.size,e),Y.size++}static getTile(e){return Y.tileSet.get(e)||""}}Y.size=0;const I=Y;const K=class extends u{constructor(){super("loading"),this.doneLoading=!1,this.safeprogress=0,this.nextScene="menu",this.progressbar=new l(this.name,new s(200,275),new s,["sss","50px Ariel","white"])}entry(e){var t,s,i,r,n,a;return i=this,r=void 0,a=function*(){this.doneLoading=!1;let i=null===(t=de.sceneList.get(null!=e?e:"menu"))||void 0===t?void 0:t.preloadimg,r=null===(s=de.sceneList.get(null!=e?e:"menu"))||void 0===s?void 0:s.preloadsfx;this.nextScene=null!=e?e:"menu",this.resources=null!=i?i:[],o.addtolist(this.resources),o.loadImages(this.resources).then((()=>{o.loadFont(),I.initialize(),I.addToTileSet(C),this.resources=null!=r?r:[],o.loadSounds(this.resources).then((()=>{var e,t;R.initialize(),(null===(e=de.sceneList.get(this.nextScene))||void 0===e?void 0:e.created)||null===(t=de.sceneList.get(this.nextScene))||void 0===t||t.create(),this.doneLoading=!0})).catch((e=>{console.error("Error loading resources:",e)}))})).catch((e=>{console.error("Error loading resources:",e)}))},new((n=void 0)||(n=Promise))((function(e,t){function s(e){try{h(a.next(e))}catch(e){t(e)}}function o(e){try{h(a.throw(e))}catch(e){t(e)}}function h(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(s,o)}h((a=a.apply(i,r||[])).next())}))}update(e){this.safeprogress=this.safeprogress<.5?this.safeprogress+e:.5,this.progressbar.text[0]=String(Math.floor(this.safeprogress/.5*100))+"%",this.doneLoading&&this.safeprogress>=.5&&(de.setActive(this.nextScene),j.initialize())}render(e){super.render(e),ue.fillBlack(),this.progressbar.render(e,this.camera.transform.position)}reset(){this.safeprogress=0}},W=class extends b{constructor(e,t,s){super(e,t,s),this.collider.layer="player"}update(e){super.update(e)}render(e,t){super.render(e,t),this.animator&&this.spriterenderer.render(this.transform.position,this.transform.scale,t,this.animator.getCurrentFrameRect())}},$=class extends e{constructor(e){super(),this.fps=4,this.currentindex=0,this.safeprogress=0,this.starttime=0,this.spritesheet=!1,this.frameWidth=0,this.frameHeight=0,this.numFrames=0,this.elapsedTime=0,this.animation=[],this.sprite=e,this.interval=1/this.fps}loadAnim(e,t,s,i){this.spritesheet=e,e&&"string"==typeof t&&s&&i?(this.sprite.image=o.imagelist["/assets/images/"+t],this.frameWidth=s,this.frameHeight=i,this.numFrames=Math.floor(this.sprite.image.width/s)):!e&&Array.isArray(t)&&(this.animation=t.map((e=>"../../assets/images/"+e)))}play(e){0!=this.fps&&(this.elapsedTime+=e,this.elapsedTime<this.interval||(this.elapsedTime=0,this.currentindex=(this.currentindex+1)%(this.spritesheet?this.numFrames:this.animation.length),this.currentindex=this.spritesheet?this.currentindex:0,this.spritesheet||(this.sprite.image.src=this.animation[this.currentindex])))}getCurrentFrameRect(){if(this.spritesheet)return[this.currentindex*this.frameWidth,0,this.frameWidth,this.frameHeight]}stop(){this.fps=0}continue(){this.fps=4}},q=class{constructor(e,t){this.mass=1,this.velocity=new s}update(e,t){t.position.x+=this.velocity.x*e,t.position.y+=this.velocity.y*e}onAddForce(e){this.velocity.y+=e.power.y/this.mass,this.velocity.x+=e.power.x/this.mass,this.velocity.y>=700&&(this.velocity.y=700)}onStopForce(e){this.velocity.x-=e.power.x,this.velocity.y-=e.power.y}reset(){this.velocity=new s}},H=class{static attach(e,t,s){var i;this.events||(this.events=new Map),this.events.has(e)||this.events.set(e,new Map),null===(i=this.events.get(e))||void 0===i||i.set(t,s)}static raiseEvent(e){if(this.events.has(e)){const t=this.events.get(e)||new Map;for(const e of t)e[1]()}}},U=class{constructor(e){this.power=null!=e?e:new s(0,0)}},X=class extends U{constructor(){super(),this.power=new s(0,30)}};class J{static initialize(){J.gravity=new X}static addforce(e,t){e.onAddForce(t)}static stopforce(e,t){e.onStopForce(t)}static applyGravity(e,t){new s(0,J.gravity.power.y*e),t.onAddForce(J.gravity)}}const D=J,N=class{constructor(e){this.player=e}},Q=class extends N{constructor(){super(...arguments),this.bouncing=!1,this.progress=0,this.bounceTime=0}onEnter(){this.progress=0,this.bouncing=!1,this.player.dead=!1,this.bounceTime=0}onUpdate(e){this.progress+=e,this.progress>=2&&this.player.setState("rescue"),this.player.transform.rotation+=3e3*e,this.unbounce(),this.bounce(),this.player.touchGround&&this.player.rb.velocity.y>=0?this.player.rb.velocity.y=0:D.addforce(this.player.rb,D.gravity)}onExit(){this.bouncing=!1,this.progress=0,this.player.dead=!1,this.bounceTime=0}onRender(e,t){}unbounce(){this.player.collider.collide("spike")[1]||(this.bouncing=!1)}bounce(){for(var e of this.player.collider.checkCollide())"spike"==e.layer&&!this.bouncing&&this.bounceTime<2&&(this.bounceTime++,this.player.rb.velocity.y*=-this.bounceTime,this.player.rb.velocity.x*=-this.bounceTime,this.bouncing=!0)}},V=class extends N{onEnter(){this.player.reset(),D.addforce(this.player.rb,new U(this.player.speed))}onUpdate(e){this.player.flagreset(),this.player.checkAllCollider(),this.player.checkBouncing(),this.player.jump(),this.player.touchGround&&this.player.rb.velocity.y>=0?this.player.rb.velocity.y=0:D.addforce(this.player.rb,D.gravity)}onExit(){}onRender(e,t){}},Z=class extends N{constructor(){super(...arguments),this.progress=0}onEnter(){if(this.player.dieOnce)return console.log("ngu vl"),void(this.player.dead=!0);this.progress=0,this.player.dieOnce=!0,this.addButton(),this.cursor=new k(de.getCurrentScene().name,new s,new s(20,20))}onUpdate(e){H.raiseEvent("spike"),this.progress+=e,console.log("rescue now!!!!"),this.killButton.update(e),this.rescueButton.update(e),this.cursor.update(e),this.progress>=5&&(this.player.dead=!0)}onRender(e,t){ue.fill("black",.4),this.rescueButton.render(e,t),this.killButton.render(e,t),this.cursor.render(e,t)}onExit(){}addButton(){let e=new S(de.getCurrentScene().name,new s(200,400),new s(200,100));e.setText("Continue"),e.text.text[1]="15px PressStart",e.text.text[2]="white",e.addonclick((()=>{this.player.setState("playing")})),this.rescueButton=e;let t=new S(de.getCurrentScene().name,new s(200,250),new s(200,100));t.setText("Menu"),t.text.text[1]="15px PressStart",t.text.text[2]="white",t.addonclick((()=>{H.raiseEvent("gameover")})),this.killButton=t}},_=class extends W{constructor(e,t,i){super(e,t,i),this.speed=new s(150,0),this.canJump=!0,this.bounced=!1,this.touchGround=!1,this.bouncable=!1,this.dead=!1,this.touchWall=!1,this.jumping=!1,this.active=!0,this.dieOnce=!1,this.rb=new q(this.transform.position,this.transform.scale),this.setUpAnimator(),this.collider.scale.y=this.transform.scale.y/2,this.states={playing:new V(this),dead:new Q(this),rescue:new Z(this)},this.setState("playing")}update(e){this.active&&(super.update(e),this.currentState.onUpdate(e),this.rb.update(e,this.transform))}setState(e){this.currentState&&this.currentState.onExit(),this.currentState=this.states[e],this.currentState.onEnter()}disable(){this.active=!1}enable(){this.active=!0}checkAllCollider(){let e=this.collider.checkCollide();for(var t of e)"wall"==t.layer&&(this.bounced=!0),"spike"==t.layer&&this.setState("dead")}flagreset(){this.touchWall=!1,this.touchGround=!1,this.dead=!1,this.bounced=!1,this.jumping=!1}checkBouncing(){this.collider.collide("wall")[1]?(this.bounce(),this.bouncable=!1):this.bouncable=!0}render(e,t){super.render(e,t),this.animator.play(e),this.currentState.onRender(e,t)}setUpAnimator(){this.spriterenderer=new a(L),this.animator=new $(this.spriterenderer),this.animator.loadAnim(!0,L,16,16)}bounce(){this.bouncable&&(this.rb.velocity.x=-this.rb.velocity.x,this.bouncable=!1,this.touchWall=!0,this.flip())}jump(){" "!=v.key&&0==v.mousepos[2]||!this.canJump||(H.raiseEvent("jump"),this.jumping=!0,this.rb.velocity.y=-600,this.canJump=!1,v.mousepos[2]=0),""!=v.key||0!=v.mousepos[2]||this.canJump||(this.canJump=!0)}reset(){super.reset(),this.rb.reset(),this.flagreset()}entry(){this.dieOnce=!1,this.setState("playing")}flip(){this.transform.flip.x*=-1,this.spriterenderer.flipimage(this.transform.flip)}},ee=class extends b{constructor(e,t,s){super(e,t,s),this.rb=new q,this.collider.layer="spike",this.spriterenderer=new a(A),this.collider.scale.y=this.transform.scale.y/3,this.collider.scale.x=.8*this.transform.scale.x}update(e){super.update(e),this.rb.update(e,this.transform)}render(e,t){super.render(e,t)}};function te(e,t){return Math.floor(Math.random()*(t-e))+e}const se=class extends h{constructor(e,t,i,r){super(e,i,r),this.spikeList=[],this.isLeft=!1,this.offset=[10,390],this.spikePool=Array.from({length:8},(()=>new ee(e,new s(-100,-100),new s(50,50)))),this.transform.rotation=90;for(var n=0;n<t;n++)this.spikeList[n]=this.spikePool[n];H.attach("touch","show",(()=>{this.show()})),H.attach("spike","show",(()=>{this.reset()}))}length(){return this.spikeList.length}update(e){let t=this.isLeft?100:-100;for(var s of this.spikeList)s.transform.position.x<this.offset[0]||s.transform.position.x>this.offset[1]?s.rb.velocity.x=t:(s.rb.velocity.x=0,s.transform.position.x=this.isLeft?this.offset[0]:this.offset[1]),s.transform.rotation=this.transform.rotation;for(var s of this.spikePool)s.update(e)}show(){for(var e of(this.isLeft=!this.isLeft,this.transform.rotation=this.isLeft?90:-90,this.spikeList))e.transform.position.x=this.isLeft?-20:420,console.log(this.spikeList);this.RandomizeY()}RandomizeY(){const e=[0,0,0,0,0,0,0,0];for(var t=0;t<Math.min(e.length-1,this.spikeList.length);t++)e[t]=1;for(t=0;t<e.length;t++){let s=te(0,e.length-1),i=e[t];e[t]=e[s],e[s]=i}let s=0;for(t=0;t<e.length;t++)1==e[t]&&(this.spikeList[s].transform.position.y=125+50*t,s++)}addSpike(e){this.spikeList[this.length()]=this.spikePool[this.length()]}hide(){for(var e of this.spikePool)e.transform.position=new s(200,-100)}entry(){this.hide(),this.isLeft=!1;for(var e=0;e<this.length();e++)this.spikeList.pop;this.spikeList=[this.spikePool[0]]}reset(){this.hide(),this.isLeft=!1}render(e,t){for(var s of this.spikePool)s.render(e,de.getCurrentScene().camera.transform.position)}},ie=class extends b{constructor(e,t,s,i){super(e,s,i),this.id=t,this.spriterenderer=new a(C)}},re=class extends ie{constructor(e,t,s,i){super(e,t,s,i),this.id=t,this.spriterenderer.color=[0,0,0,0],this.spike=new ee(e,s,i),this.spike.collider.scale.x=this.transform.scale.x/2,this.spike.collider.scale.y=this.transform.scale.y}render(e,t){this.spike.render(e,t)}update(e){this.spike.transform.rotation=this.transform.rotation,this.spike.update(e)}},ne=class extends h{constructor(e,t,s,i,r){super(e,i,r),this.size=s,this.loadTile(e,t)}render(e,t){for(var s of this.map)for(var i of s)i.render(e,t)}reset(){for(var e of(super.reset(),this.map))for(var t of e)t.reset()}update(e){for(var t of this.map)for(var s of t)s.transform.rotation=this.transform.rotation,s.update(e)}loadTile(e,t){this.map=[];for(let i=0;i<t.length;i++){this.map[i]=[];for(let r=0;r<t[i].length;r++){let n=(r+.5)*this.size.x+this.transform.position.x,o=(i+.5)*this.size.y+this.transform.position.y,a=new s(n,o);const h=new re(e,t[i][r],a,this.size);this.map[i].push(h)}}}},oe=class extends h{render(e,t){let s=this.transform.position,i=this.transform.scale;this.spriterenderer.render(s,i,t,this.animator.getCurrentFrameRect())}},ae=class extends oe{constructor(e,t,s,i){super(e,s,i),this.speed=t,this.spriterenderer=new a(E),this.animator=new $(this.spriterenderer),this.animator.loadAnim(!0,E,16,16),this.rb=new q(s,i),this.rb.velocity.x=this.speed,this.reset()}update(e){super.update(e),this.rb.update(e,this.transform),this.animator.play(e),(this.transform.position.x>d.x+100||this.transform.position.x<-100)&&(this.rb.velocity.x=-this.rb.velocity.x,this.transform.flip.x=-this.transform.flip.x,this.spriterenderer.flipimage(this.transform.flip))}reset(){this.transform.position.y=te(c.y+100,d.y-100),this.transform.position.x=te(c.x,d.x)}},he=class extends h{constructor(e,t){super(e),this.emitting=!1,this.elapse=0,this.progress=2,this.key="",this.list=[],this.playerPos=t,this.key=e,H.attach("jump","emitParticle",(()=>{this.emitParticle(e,t,0)}))}update(e){var t;this.elapse+=e,this.progress<=.5&&(this.progress+=e),this.progress>=.5&&this.emitting&&(this.emitting=!1),.1===(null===(t=this.list[0])||void 0===t?void 0:t.transform.scale.x)&&this.list.shift(),this.shrink(e),this.emitting&&this.elapse>=.1&&(this.emit(this.key,this.playerPos.transform.position,0),this.elapse=0)}emitParticle(e,t,s){this.progress<=3&&(this.emitting=!0,this.progress=0)}emit(e,t,i){var r=t.x,n=t.y;let o=new h(e,new s(r,n),new s(20,20));o.spriterenderer.color=[255,255,255,1],this.list.push(o)}shrink(e){for(var t of this.list)t.transform.scale.x=t.transform.scale.x-40*e>0?t.transform.scale.x-40*e:.1}reset(){this.list=[],this.emitting=!1,this.progress=0}render(e,t){for(var s of this.list)s.render(e,t)}},le=class extends u{constructor(){super("game"),this.preloadimg=[L,T,A,E,C],this.preloadsfx=[F,O],H.attach("touch","increase",(()=>{this.increase()})),H.attach("gameover","gameover",(()=>{this.GameOver()}))}create(){this.created=!0,this.createAudioChannel(),this.score=0,this.addBG(),this.addScoreText(),this.player=new _(this.name,new s(200,250),new s(30,30)),this.spikePool=new se(this.name,1),this.particle=new he(this.name,this.player),this.addWall(),this.addFloor()}createAudioChannel(){this.jumpsound=new G(this.name,F,"jump")}entry(){R.play("bgm"),this.player.entry(),this.spikePool.entry(),this.score=0}update(e){this.created&&(super.update(e),this.player.update(e),this.particle.update(e),this.spikePool.update(e),this.scoreText.text[0]=String(this.score),this.player.touchWall&&H.raiseEvent("touch"),this.player.dead&&H.raiseEvent("gameover"),de.pausing)}GameOver(){j.setScore(this.score),de.setActive("menu")}reset(){super.reset(),this.player.reset(),this.spikePool.reset(),this.particle.reset()}increase(){this.player.currentState instanceof V&&(this.jumpsound.play(),this.score%10==5&&this.spikePool.length()<7&&this.spikePool.addSpike(this.name),this.score++,this.score>j.highscore&&j.setHighScore(this.score))}addWall(){let e=new b(this.name,new s(0,350),new s(5,700));e.spriterenderer=new a(C),e.collider.layer="wall",this.pushGameObject(e),e=new b(this.name,new s(400,350),new s(5,700)),e.spriterenderer=new a(C),e.collider.layer="wall",this.pushGameObject(e)}addFloor(){let e=new ne(this.name,[[0,0,0,0,0,0,0,0,0]],new s(50,50),new s(0,520));this.pushGameObject(e);let t=new ne(this.name,[[0,0,0,0,0,0,0,0,0]],new s(50,50),new s(0,-20));t.transform.rotation=180,this.pushGameObject(t)}render(e){if(!this.created)return;super.render(e);let t=this.camera.transform.position;this.scoreText.render(e,t),this.particle.render(e,t),this.player.render(e,t),this.spikePool.render(e,t),this.pause()}addScoreText(){let e=[String(this.score),"100px PressStart","white"];this.scoreText=new l(this.name,new s(200,200),new s(200,100),e)}addBG(){let e=new h(this.name,new s(200,350),new s(400,700));e.spriterenderer=new a(T),this.pushGameObject(e),this.addBird(2,50,50),this.addBird(1,100,100)}addBird(e,t,i){for(let r=0;r<e;r++)this.pushGameObject(new ae(this.name,i,new s(100,100),new s(t,t)))}};class ce{static initialize(){ce.sceneList=new Map,ce.initScene(),ce.sceneList.set("loading",new K),ce.setActive("menu")}static initScene(){ce.sceneList.set("menu",new B),ce.sceneList.set("game",new le)}static update(e){var t;null===(t=ce.sceneList.get(ce.activeScene))||void 0===t||t.update(e)}static render(e){var t;null===(t=ce.sceneList.get(ce.activeScene))||void 0===t||t.render(e)}static setActive(e){var t;if("loading"==this.getCurrentScene().name||(null===(t=this.sceneList.get(e))||void 0===t?void 0:t.created))return this.getCurrentScene().reset(),this.activeScene=e,void this.getCurrentScene().entry();this.getCurrentScene().reset(),this.activeScene="loading";let s=this.getCurrentScene();s instanceof K&&s.entry(e).then((()=>{}))}static getCurrentScene(){return ce.sceneList.get(ce.activeScene)||new u}static pause(){console.log("pausing"),ce.pausing=!0,ce.resumable=!1}static resume(){console.log("resume"),ce.pausing=!1}}ce.pausing=!1,ce.resumable=!1;const de=ce;class pe{static initialize(e){pe.camera=e,pe.canvas||(pe.canvas=document.createElement("canvas")),pe.canvas.getContext("2d"),pe.canvas.height=e.transform.scale.y,pe.canvas.width=e.transform.scale.x,pe.canvas.style.position="absolute",pe.canvas.style.top="50%",pe.canvas.style.left="50%",pe.canvas.style.transform="translate(-50%, -50%)",document.body.appendChild(pe.canvas),pe.resizeCanvas()}static flip(){const e=document.querySelector("canvas").getContext("2d");e&&(e.imageSmoothingEnabled=!1,e.fillStyle="white",e.fillRect(0,0,pe.camera.transform.scale.x,pe.camera.transform.scale.y))}static getCanvas(){return pe.canvas}static resizeCanvas(){const e=window.innerWidth/window.innerHeight,t=d.x/d.y;let s,i;e>t?(i=window.innerHeight,s=i*t):(s=window.innerWidth,i=s/t),pe.canvas.style.width=`${s}px`,pe.canvas.style.height=`${i}px`,pe.ratioX=s/d.x,pe.ratioY=i/d.y,pe.canvas.style.imageRendering="pixelated"}static pause(){const e=document.querySelector("canvas").getContext("2d");e&&(e.globalAlpha=.9,e.imageSmoothingEnabled=!1,e.fillStyle="black",e.fillRect(0,0,pe.camera.transform.scale.x,pe.camera.transform.scale.y),e.globalAlpha=1),new l("",new s(200,250),new s,["Click to continue","30px Ariel","white"]).render(0,de.getCurrentScene().camera.transform.position)}static fillBlack(){const e=document.querySelector("canvas").getContext("2d");e&&(e.imageSmoothingEnabled=!1,e.fillStyle="black",e.fillRect(0,0,pe.camera.transform.scale.x,pe.camera.transform.scale.y))}static fill(e,t){const s=document.querySelector("canvas").getContext("2d");s&&(s.globalAlpha=t,s.imageSmoothingEnabled=!1,s.fillStyle=e,s.fillRect(0,0,pe.camera.transform.scale.x,pe.camera.transform.scale.y),s.globalAlpha=1)}static screenShake(){de.getCurrentScene().camera.transform.position=new s(c.x-10,c.y-10),this.shaking=!0}static rePosScreen(e){let t=de.getCurrentScene().camera;t.transform.position.x>=c.x&&(t.transform.position=new s(c.x,c.y),this.shaking=!1),t.transform.position=new s(c.x+10*e,c.y+10*e)}}pe.shaking=!1;const ue=pe;class me{static initialize(){me.prevTime=0,me.currentTime=performance.now()/1e3}static startFrame(){me.currentTime=performance.now()/1e3,me.delta()}static endFrame(){me.prevTime=me.currentTime}static delta(){me.deltaTime=me.currentTime-me.prevTime}}const fe=me,ge=class{constructor(){de.initialize(),D.initialize()}loop(){fe.startFrame(),de.pausing&&(fe.deltaTime=0),this.update(fe.deltaTime),this.render(fe.deltaTime),fe.endFrame(),requestAnimationFrame(this.loop.bind(this))}update(e){de.update(e)}render(e){de.render(e)}start(){var e;fe.initialize();let t=null===(e=de.sceneList.get(de.activeScene))||void 0===e?void 0:e.camera;t&&ue.initialize(t),v.initialize(),this.loop()}};document.addEventListener("click",(function e(){document.title="Don't Touch The Spike";let t=new ge;document.removeEventListener("click",e),t.start()}))})();